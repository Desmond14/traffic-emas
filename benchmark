#!/usr/bin/env escript

-define(PROGRAM, "benchmark").


main(Args) ->
    add_deps(),
    Options = get_options(Args),
    ProblemSize = get_problem_size(Options),
    Time = get_time(Options),
    CarsNumber = get_option(Options, cars_number),
    RandomizationChance = get_option(Options, randomization_chance),
    FitnessRatio = benchmark:test(Time, ProblemSize, CarsNumber, RandomizationChance, Options),
    %%file:write_file("result.txt", integer_to_list(round(Fitness)), [append]),
    io:format("Benchmark result: ~p\n", [FitnessRatio]),
    file:write_file("benchmark.txt", io_lib:fwrite("~p.\n", [FitnessRatio]), [append]),
    ok.


add_deps() ->
    ScriptPath = filename:dirname(escript:script_name()),
    code:add_patha(ScriptPath ++  "/ebin"),
    code:add_pathsa(filelib:wildcard(ScriptPath ++ "/deps/*/ebin")).

get_options(Args) ->
    Specs = options_spec(),
    Options =
        case getopt:parse(Specs, Args) of
            {ok, {Parsed, [] = _Others} } ->
                Parsed;

            {ok, {_Parsed, Others}} ->
                usage(),
                erlang:exit("Not supported options", Others);

            {error, Data} ->
                usage(),
                erlang:exit("Error parsing args", Data)
        end,
    Options.


add_time(Spec) ->
    [time_spec()|
     Spec].

time_spec() ->
    {time, $t, "time", integer,
     "amount of time to run given simulaiton, in milliseconds"}.

get_time(Options) ->
    case proplists:get_value(time, Options) of
        undefined ->
            usage(),
            erlang:exit("Missing time argument");
        Time ->
            Time
    end.

get_problem_size(Options) ->
    case proplists:get_value(problem_size, Options) of
        undefined ->
            usage(),
            erlang:exit("Missing time argument");
        ProblemSize ->
            ProblemSize
    end.

get_option(Options, OptionName) ->
    case proplists:get_value(OptionName, Options) of
            undefined ->
                usage(),
                erlang:exit("Missing argument");
            Option ->
                Option
        end.

options_spec() ->
    Specs = emas_config:options_specs() ++ [{cars_number, undefined,"cars_number",{integer, 5},"Number of cars to evaluate"}, {randomization_chance, undefined, "randomization_chance", {float, 0.001}, "Randomization chance"}],
    add_time(Specs).

usage() ->
    getopt:usage(options_spec(), ?PROGRAM).


